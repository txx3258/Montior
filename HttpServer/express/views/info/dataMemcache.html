<%- include ../template/_header.html %>
    <aside id="app-sidebar">
        <%- include ../template/_navigator.html %>
        <%- include ../template/_navigator_data.html %>
    </aside>
    <!-- ▲ Main sidebar -->

    <!-- ▼ Main container -->
    <div id="app-container" class="container">

        <div id="app-third-sidebar" class="js-app-third-sidebar">
            <div class="zent-breadcrumb">
                <span><%= title %></span>
            </div>
        </div>

        <div id="app-container-top"></div>
        <div class="app">
            <div class="app-inner clearfix" style="width:1030px">
                <div class="app-init-container">
                    <div data-version="mini" id="js-app-content" class="app__content stat-dashboard">
                        <div class="js-app-inner app-inner-wrap hide" style="display: block;">
                            <div id="js-overview-block">
                                <div class="ui-block-head">
                                    <h3>今日实时</h3>
                                    <span class="c-gray">(更新时间：2016-07-05 08:08:23)</span>
                                    <div class="ui-block-head-help">
                                        <a href="javascript:;" class="js-help-notes">
                                            <div class="js-notes-cont hide">
                                                <p>今日实时数据的统计时间均为今日零时截至当前更新时间。</p>
                                                <p><strong>浏览UV：</strong>统计时间内，浏览这个店铺所有页面（包括店铺主页、单品页、会员主页等）的浏览人数。</p>
                                                <p><strong>浏览PV：</strong>统计时间内，浏览这个店铺所有页面（包括店铺主页、单品页、会员主页等）的浏览次数。</p>
                                                <p><strong>付款订单数：</strong>统计时间内，成功付款的订单数，一个订单对应唯一一个订单号。</p>
                                                <p><strong>付款金额(元)：</strong>统计时间内，成功付款的交易实付金额。</p>
                                                <p><strong>付款商品件数：</strong>统计时间内，成功付款订单的商品件数之和。</p>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                                <div class="ui-overview ui-box">
                                    <ul>
                                        <li>
                                            <h5>102|343</h5>
                                            <h6>访问总数/出错总数(百万|个)</h6>
                                        </li>
                                        <li>
                                            <h5>3209|111</h5>
                                            <h6>group((百万|个))</h6>
                                        </li>
                                        <li>
                                            <h5><a href="">100|3400</a></h5>
                                            <h6>applist(百万|个)</h6>
                                        </li>
                                        <li>
                                            <h5>111|534</h5>
                                            <h6>menu(百万|个)</h6>
                                        </li>
                                        <li>
                                            <h5>121212|12121</h5>
                                            <h6>typetag(百万|个)</h6>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div id="js-overview" class="widget widget-overview">
                                <div class="widget-inner">
                                    <div class="ui-block-head">
                                        <h3>昨日概况</h3>
                                        <nav>
                                            <span>
                                                    <a href="//koudaitong.com/v2/statcenter/order" class="new-window" target="_blank">详细 》</a>
                                                </span>
                                        </nav>
                                        <div class="ui-block-head-help">
                                            <a href="javascript:void(0);" class="js-help-notes"></a>
                                            <div class="js-notes-cont hide">
                                                <p><strong>内部访问PV：</strong>即店铺所有页面的浏览PV减去外部分享PV；</p>
                                                <p><strong>外部分享PV：</strong>粉丝通过他人分享链接访问产生的流量；</p>
                                                <p><strong>导出UV：</strong>粉丝访问你的商城跳出到站外产生的访客数；</p>
                                                <p><strong>导出PV：</strong>粉丝访问你的商城跳出到站外产生的页面数。</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="widget-body">
                                        <div class="js-body widget-body__inner clearfix">
                                            <div class="js-body-desc overview-desc">

                                                <ul style="width:1028px">
                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">浏览UV</p>
                                                    </li>
                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">浏览PV</p>
                                                    </li>
                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">访问PV</p>
                                                    </li>
                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">享PV</p>
                                                    </li>

                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">分享PV</p>
                                                    </li>

                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">外部PV</p>
                                                    </li>

                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">外部PV</p>
                                                    </li>

                                                    <li style="width:60px">
                                                        <p class="num">0</p>
                                                        <p class="h4">外部分</p>
                                                    </li>
                                                </ul>

                                                <ul style="width:1028px">
                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">导出UV</p>
                                                    </li>
                                                    <li>
                                                        <p class="num">0</p>
                                                        <p class="h4">导出PV</p>
                                                    </li>
                                                    <li class="gray">
                                                        <p class="num">暂无
                                                            <!--0-->
                                                        </p>
                                                        <p class="h4">点击去看看</p>
                                                    </li>
                                                    <li class="gray">
                                                        <p class="num">暂无
                                                            <!--0-->
                                                        </p>
                                                        <p class="h4">点击立即购买</p>
                                                    </li>
                                                </ul>

                                                <ul style="width:1028px">
                                                    <li>
                                                        <p class="num">
                                                            <a href="//koudaitong.com/v2/trade/order#list&amp;type=all&amp;state=all&amp;keyword[start_time]=2016-07-04 00:00:00&amp;keyword[end_time]=2016-07-04 23:59:59"> 0 </a>
                                                        </p>
                                                        <p class="h4">下单笔数</p>
                                                    </li>
                                                    <li>
                                                        <p class="num">
                                                            <a href="//koudaitong.com/v2/trade/order#list&amp;type=all&amp;state=tosend&amp;keyword[start_time]=2016-07-04 00:00:00&amp;keyword[end_time]=2016-07-04 23:59:59&amp;time_type=pay_time">0</a>
                                                        </p>
                                                        <p class="h4">付款订单</p>
                                                    </li>
                                                    <li>
                                                        <p class="num">
                                                            <a href="//koudaitong.com/v2/trade/order#list&amp;type=all&amp;state=send&amp;keyword[start_time]=2016-07-04 00:00:00&amp;keyword[end_time]=2016-07-04 23:59:59&amp;time_type=express_time">0</a>
                                                        </p>
                                                        <p class="h4">发货订单</p>
                                                    </li>
                                                    <li class="gray">
                                                        <p class="num">暂无
                                                            <!-- 0 -->
                                                        </p>
                                                        <p class="h4">被维权数</p>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="js-body-chart overview-chart">
                                                <div style="position: relative; overflow: hidden; width: 297px; height: 215px;">
                                                    <div width="594" height="430" data-id="bg" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></div>
                                                    <canvas width="594" height="430" data-id="0" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="1" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="2" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="3" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="4" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="5" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="6" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="7" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                    <canvas width="594" height="430" data-id="hover" id="_zrender_hover_" style="position: absolute; left: 0px; top: 0px; width: 297px; height: 215px;"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="js-rank-myself rank-myself" style="display:none;">

                                你刚刚入驻有赞，需要明天才能加入排名哦！


                            </div>

                            <style>
                                #historyTend {
                                    font: 10px sans-serif;
                                }
                                
                                .axis path,
                                .axis line {
                                    fill: none;
                                    stroke: #000;
                                    shape-rendering: crispEdges;
                                }
                                
                                .x.axis path {
                                    display: none;
                                }
                                
                                .line {
                                    fill: none;
                                    stroke: steelblue;
                                    stroke-width: 1.5px;
                                }
                            </style>

                            </style>
                            <link rel="stylesheet" type="text/css" href="/css/jquery.datetimepicker.min.css" />
                            <div id="js-user-rank" class="widget widget-user-rank">
                                <div class="widget-inner">
                                    <div class="ui-block-head">
                                        <h3>历史趋势</h3>
                                    </div>

                                    <div style="width: 100%;clear :both;height:50px">
                                        <div style="float: left; margin-top : 5px"> 起点:</div>
                                        <input id="datepicker1" name="start" style=" float: left; margin-left : 8px; width: 95px; height: 20px" type="text"
                                        />

                                        <div style="float: left; margin-top:5px; margin-left : 12px">终点: </div>
                                        <input  id="datepicker2" name="end" style=" float: left; margin-left: 8px ; width : 95px; height: 20px" type="text"
                                        />
            
                                        <div style="float: left; margin-top:5px; margin-left:12px">角色名称: </div>
                                        <select id="roleName" style="float: left; margin:5px 0 0 8px ; width : 50px; height: 20px" >
                                            <option value="master">主</option>
                                            <option value="slave">从</option>    
                                        </select>

                                        <div style="float: left; margin-top:5px; margin-left:12px">systemCode:</div>
                                        <select id="systemCode" style="float: left; margin:5px 0 0 8px ; width : 50px; height: 20px" >
                                             <option value="-1">全部</option>   
                                        </select>

                                        <div style="float: left; margin-top:5px; margin-left:12px">机器域名:</div>
                                        <select id="serverHost" style="float: left; margin:5px 0 0 8px ; width : 50px; height: 20px" >
                                            <option value="-1">全部</option>   
                                        </select>

                                        <div style="float: left; margin-top:5px; margin-left:12px">调用方法:</div>
                                        <select id="methName" style="float: left; margin:5px 0 0 8px ; width : 50px; height: 20px" >
                                            <option value="-1">全部</option>
         
                                        </select>

                                        <div style="float: left; margin-top:5px;margin-left:12px">统计量: </div>
                                        <select id="statsWay" style="float: left; margin:5px 0 0 8px ; width: 80px; height: 20px" >
                                            <option value="avgCost">平均耗时</option>
                                            <option value="maxCost">最大耗时</option>
                                            <option value="totalCount">访问总数</option> 
                                            <option value="failCount">失败总数</option>     
                                        </select>

                                        <input id="queryBtn" type="button" value="查询" style=" float: left; margin-left : 30px; width : 50px; height: 25px; margin-top: 0px;"/>
                                    </div>
                                    <div id="historyTend" class="widget-body">

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="notify-bar js-notify animated hinge hide">
                </div>
            </div>
        </div>
    </div>
    <!-- ▲ Main container -->

    </div>
    <%- include ../template/_footer.html %>
        <script src="http://120.25.169.11/assets/js/d3.v3.min.js"></script>
        <script type="text/javascript" src="http://120.25.169.11/api/jquery-1.8.3.js"></script>
        <script type="text/javascript" src="/js/jquery.datetimepicker.full.min.js"></script>

        
        <script type="text/javascript">
        $.ajax({url:'/info/chart/line/distinctField?type=noSql&key=["systemCode","methName","serverHost"]&bizCode=distinct',
            success:function(data){
            data.systemCode.forEach(function(item){
                $("#systemCode").append('<option value="'+item+'">'+item+'</option>')
            });
            data.methName.forEach(function(item){
                $("#methName").append('<option value="'+item+'">'+item+'</option>')
            });
            data.serverHost.forEach(function(item){
                $("#serverHost").append('<option value="'+item+'">'+item+'</option>')
            });
        }});
        $.datetimepicker.setLocale('en');
        $('#datetimepicker_format').datetimepicker({value:'2016/07/18 05:03:00', format: $("#datetimepicker_format_value").val()});
            console.log($('#datetimepicker_format').datetimepicker('getValue'));
            $("#datetimepicker_format_change").on("click", function(e){
	        $("#datetimepicker_format").data('xdsoft_datetimepicker').setOptions({format: $("#datetimepicker_format_value").val()});
        });
        $("#datetimepicker_format_locale").on("change", function(e){
	        $.datetimepicker.setLocale($(e.currentTarget).val());
        });

        $('#datepicker1').datetimepicker({
            dayOfWeekStart : 1,
            lang:'en',
            startDate:new Date().toLocaleDateString()
        });
 
        $('#datepicker2').datetimepicker({
            dayOfWeekStart : 1,
            lang:'en',
            startDate:new Date().toLocaleDateString()
        }); 

        var start = undefined,end = undefined;
        $('#queryBtn').click( function(){
            var date1 = $('#datepicker1').val();
            var date2 = $('#datepicker2').val();
            if (date1.length<10||date2.length<10){
                alert('请选择日期！');
                return;
            }

            start=new Date(date1+':00').getTime();
            end=new Date(date2+':00').getTime();
            if (start>=end){
                alert( '终点时间小于起点时间!' );
                return;
            }  

            var statsWay = $("#statsWay").val();
            var roleName = $("#roleName").val();
            var systemCode = $("#systemCode").val();
            var serverHost = $("#serverHost").val();
            var methName = $("#methName").val();
            
            var query = 'biz='+statsWay+'&type=noSql&action=find&cond="type":"memcached","startTime":{"$gt":'+start+',"$lt":'+end+'},"roleName":"'+roleName+'"';
            if (serverHost!=-1){
                query+=',"serverHost":"'+serverHost+'"';
            }
            if (systemCode!=-1){
                query+=',"systemCode":"'+systemCode+'"';
            }
            if (methName!=-1){
                query+=',"methName":"'+methName+'"';
            }
            query+='&fields=startTime%20methName%20'+statsWay;
            var margin = {top: 20, right: 80, bottom: 30, left: 50},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

            var parseDate = d3.time.format("%h%m%s").parse;
            var x = d3.time.scale().range([0, width]);
            var y = d3.scale.linear().range([height, 0]);
            var color = d3.scale.category10();
            var xAxis = d3.svg.axis().scale(x).orient("bottom");
            var yAxis = d3.svg.axis().scale(y).orient("left");

            var line = d3.svg.line().interpolate("basis")
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.mum); });
            var svg = d3.select("#historyTend").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            d3.json("/info/chart/line?"+query, function(error, datas) {
                if (error) throw error;
                color.domain(datas.key);
        
                var data = datas.value;
                data.forEach(function(d) {
                    d.date = new Date(d.startTime);
                });
    
                var indexs = color.domain().map(function(name) {
                return {
                    name: name,
                    values: data.map(function(d) {
                        var val = d[name];
                        if (!val){
                            val = 0.00;
                        }
                        return {date: d.date, mum: val};
                        })
                    };
                });

            x.domain(d3.extent(data, function(d) { return d.date; }));

            var yy = [
                d3.min(indexs, function(c) { return d3.min(c.values, function(v) { return v.mum; }); }),
                d3.max(indexs, function(c) { return d3.max(c.values, function(v) { return v.mum; }); })
            ]
            y.domain(yy);

  svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + height + ")").call(xAxis);

  svg.append("g").attr("class", "y axis").call(yAxis).append("text")
      .attr("transform", "rotate(-90)").attr("y", 6).attr("dy", ".71em")
      .style("text-anchor", "end").text("");

  var city = svg.selectAll(".city")
      .data(indexs)
      .enter().append("g")
      .attr("class", "city");

  city.append("path")
      .attr("class", "line")
      .attr("d", function(d) { 
          return  line(d.values); 
      })
      .style("stroke", function(d) { 
          return color(d.name); 
      });

  city.append("text")
      .datum(function(d) { 
          return {
          name: d.name, value: d.values[d.values.length - 1]}; 
      })
      .attr("transform", function(d) {
           return "translate(" + x(d.value.date) + "," + y(d.value.mum) + ")"; 
      })
      .attr("x", 3)
      .attr("dy", ".35em")
      .text(function(d) { return d.name; });
});
    });




    </script>